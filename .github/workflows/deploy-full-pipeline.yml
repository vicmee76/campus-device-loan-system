name: Full Deployment Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
# =========================================================
# 1️⃣ TERRAFORM – Infrastructure
# =========================================================
  terraform:
    name: Terraform Infrastructure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.x

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Detect existing DigitalOcean project
        working-directory: infra/terraform
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
          ENVIRONMENT: ${{ vars.ENVIRONMENT || 'dev' }}
        run: |
          PROJECT_NAME="campus-device-loan-${ENVIRONMENT}"
          
          PROJECT_RESPONSE=$(curl -s -X GET \
            -H "Authorization: Bearer ${DIGITALOCEAN_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://api.digitalocean.com/v2/projects")
          
          PROJECT_ID=$(echo "$PROJECT_RESPONSE" | jq -r --arg name "$PROJECT_NAME" '.projects[] | select(.name == $name) | .id')
          
          if [ -n "$PROJECT_ID" ] && [ "$PROJECT_ID" != "null" ]; then
            echo "PROJECT_EXISTS=true" >> $GITHUB_ENV
            echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
            echo "Found existing project: $PROJECT_NAME (ID: $PROJECT_ID)"
          else
            echo "PROJECT_EXISTS=false" >> $GITHUB_ENV
            echo "Project does not exist: $PROJECT_NAME"
          fi

      - name: Terraform Init
        working-directory: infra/terraform
        env:
          TF_VAR_digitalocean_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          TF_VAR_github_repo_url: ${{ secrets.REPO_URL }}
          TF_VAR_database_url: ${{ secrets.DATABASE_URL }}
        run: terraform init

      - name: Import existing project
        if: env.PROJECT_EXISTS == 'true'
        working-directory: infra/terraform
        env:
          TF_VAR_digitalocean_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          TF_VAR_github_repo_url: ${{ secrets.REPO_URL }}
          TF_VAR_database_url: ${{ secrets.DATABASE_URL }}
        run: |
          terraform import digitalocean_project.main ${{ env.PROJECT_ID }} || echo "Project may already be in state"

      - name: Terraform Validate
        working-directory: infra/terraform
        env:
          TF_VAR_digitalocean_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          TF_VAR_github_repo_url: ${{ secrets.REPO_URL }}
          TF_VAR_database_url: ${{ secrets.DATABASE_URL }}
        run: terraform validate

      - name: Terraform Plan
        working-directory: infra/terraform
        env:
          TF_VAR_digitalocean_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          TF_VAR_github_repo_url: ${{ secrets.REPO_URL }}
          TF_VAR_database_url: ${{ secrets.DATABASE_URL }}
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        working-directory: infra/terraform
        env:
          TF_VAR_digitalocean_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          TF_VAR_github_repo_url: ${{ secrets.REPO_URL }}
          TF_VAR_database_url: ${{ secrets.DATABASE_URL }}
        run: terraform apply -auto-approve tfplan


# =========================================================
# 2️⃣ DATABASE – Migrations & Deterministic Seeding
# =========================================================
  database:
    name: Database Setup
    runs-on: ubuntu-latest
    needs: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install database dependencies
        working-directory: database
        run: npm install

      # ---- Run migrations (TLS-safe for Aiven) ----
      - name: Run migrations
        working-directory: database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_TLS_REJECT_UNAUTHORIZED: "0"
        run: npm run migrate:latest

      # ---- Seed database IF EMPTY (single source of truth) ----
      - name: Seed database if empty
        working-directory: database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_TLS_REJECT_UNAUTHORIZED: "0"
        run: |
          cat > seed-if-empty.js << 'SCRIPT_EOF'
          require('ts-node/register');
          const config = require('./knexfile.ts').default;
          const knex = require('knex');
          const { execSync } = require('child_process');

          const db = knex(config.production || config.development);

          async function run() {
            const result = await db('devices').count('* as count').first();
            const count = Number(result.count || 0);

            if (count === 0) {
              console.log('Database empty → running seeds');
              execSync('npm run seed', { stdio: 'inherit' });
            } else {
              console.log('Database already seeded → skipping');
            }

            await db.destroy();
          }

          run().catch(async (e) => {
            console.error(e);
            await db.destroy();
            process.exit(1);
          });
          SCRIPT_EOF

          node seed-if-empty.js


# =========================================================
# 3️⃣ DEVICE SERVICE
# =========================================================
  device-service:
    name: Device Service
    runs-on: ubuntu-latest
    needs: database

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: backend/device-service
        run: npm install

      - name: Run unit tests
        working-directory: backend/device-service
        run: npm run test:unit

      - name: Run integration tests
        working-directory: backend/device-service
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_TLS_REJECT_UNAUTHORIZED: "0"
        run: npm run test:integration

      - name: Build project
        working-directory: backend/device-service
        run: npm run build

      - name: Trigger DigitalOcean deployment
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.digitalocean.com/v2/apps/${{ secrets.DEVICE_APP_ID }}/deployments


# =========================================================
# 4️⃣ LOAN SERVICE
# =========================================================
  loan-service:
    name: Loan Service
    runs-on: ubuntu-latest
    needs: device-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: backend/loan-service
        run: npm install

      - name: Run unit tests
        working-directory: backend/loan-service
        run: npm run test:unit

      - name: Run integration tests
        working-directory: backend/loan-service
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_TLS_REJECT_UNAUTHORIZED: "0"
        run: npm run test:integration

      - name: Build project
        working-directory: backend/loan-service
        run: npm run build

      - name: Trigger DigitalOcean deployment
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.digitalocean.com/v2/apps/${{ secrets.LOAN_APP_ID }}/deployments


# =========================================================
# 5️⃣ FRONTEND
# =========================================================
  frontend:
    name: Frontend
    runs-on: ubuntu-latest
    needs: loan-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: frontend
        run: npm install

      - name: Run tests
        working-directory: frontend
        run: npm test

      - name: Build Next.js app
        working-directory: frontend
        run: npm run build

      - name: Deploy frontend
        run: echo "Frontend deployment step — configure hosting target"
