name: Full Deployment Pipeline

"on":
  workflow_dispatch:
  push:
    branches:
      - main

env:
  DEVICE_APP_NAME: device-service-dev
  LOAN_APP_NAME: loan-service-dev
  FRONTEND_APP_NAME: campus-frontend-dev
  DB_CLUSTER_NAME: campus-device-loan-dev-db

jobs:
# =========================================================
# Infrastructure managed by DigitalOcean App Platform
# Auto-deploys on push to main
# =========================================================

# =========================================================
# 0️⃣ TERRAFORM – Provision DigitalOcean App Platform Apps
# =========================================================
  terraform:
    name: Terraform (Provision Apps)
    runs-on: ubuntu-latest
    outputs:
      database_url: ${{ steps.tf_outputs.outputs.database_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform init
        working-directory: infra/terraform
        env:
          TF_VAR_do_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
        run: terraform init

      - name: Import existing DO resources (avoid name already exists)
        working-directory: infra/terraform
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
          TF_VAR_do_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}
          TF_VAR_jwt_expires_in: ${{ secrets.JWT_EXPIRES_IN }}
        run: |
          set -euo pipefail

          # Import Apps by name (if they already exist in your DO account).
          # NOTE: The list endpoint can be paginated AND often does not include spec.name,
          # so we paginate through all apps, then resolve each name via GET /v2/apps/{id}.

          list_all_app_ids () {
            local url="https://api.digitalocean.com/v2/apps?per_page=200&page=1"
            while [ -n "$url" ]; do
              local resp next
              resp="$(curl -s -H "Authorization: Bearer ${DIGITALOCEAN_TOKEN}" "$url")"

              # Emit ids found on this page
              echo "$resp" | jq -r '.apps[]?.id'

              # Follow pagination if present
              next="$(echo "$resp" | jq -r '.links.pages.next // empty')"
              url="$next"
            done
          }

          find_app_id () {
            local app_name="$1"
            local id app_json name

            while IFS= read -r id; do
              [ -z "$id" ] && continue
              app_json="$(curl -s -H "Authorization: Bearer ${DIGITALOCEAN_TOKEN}" "https://api.digitalocean.com/v2/apps/${id}")"
              name="$(echo "$app_json" | jq -r '.app.spec.name // .app.name // empty')"
              if [ "$name" = "$app_name" ]; then
                echo "$id"
                return 0
              fi
            done < <(list_all_app_ids)

            return 1
          }

          import_app () {
            local tf_addr="$1"
            local app_name="$2"
            local app_id
            app_id="$(find_app_id "$app_name" || true)"
            if [ -n "$app_id" ] && [ "$app_id" != "null" ]; then
              if ! terraform state show -no-color "$tf_addr" >/dev/null 2>&1; then
                terraform import -var-file=env/dev.tfvars "$tf_addr" "$app_id"
              fi
            else
              echo "WARN: No existing app found for name='${app_name}'."
            fi
          }

          import_app "digitalocean_app.device"   "${DEVICE_APP_NAME}"
          import_app "digitalocean_app.loan"     "${LOAN_APP_NAME}"
          import_app "digitalocean_app.frontend" "${FRONTEND_APP_NAME}"

          # Fail fast: if apps already exist in DO but we couldn't import them, `terraform apply`
          # will try to create and will hit 409 (name already exists).
          terraform state show -no-color digitalocean_app.device   >/dev/null 2>&1 || { echo "ERROR: digitalocean_app.device not in state after import. Aborting."; exit 1; }
          terraform state show -no-color digitalocean_app.loan     >/dev/null 2>&1 || { echo "ERROR: digitalocean_app.loan not in state after import. Aborting."; exit 1; }
          terraform state show -no-color digitalocean_app.frontend >/dev/null 2>&1 || { echo "ERROR: digitalocean_app.frontend not in state after import. Aborting."; exit 1; }

          # Import DB cluster by name (if it already exists)
          DBS_JSON="$(curl -s -H "Authorization: Bearer ${DIGITALOCEAN_TOKEN}" https://api.digitalocean.com/v2/databases?per_page=200)"
          DB_ID="$(echo "$DBS_JSON" | jq -r --arg n "${DB_CLUSTER_NAME}" '.databases[] | select(.name == $n) | .id' | head -n 1)"
          if [ -n "$DB_ID" ] && [ "$DB_ID" != "null" ]; then
            if ! terraform state list | grep -q "^digitalocean_database_cluster.postgres$"; then
              terraform import -var-file=env/dev.tfvars digitalocean_database_cluster.postgres "$DB_ID"
            fi
          fi

      - name: Terraform validate
        working-directory: infra/terraform
        run: terraform validate

      - name: Terraform plan
        working-directory: infra/terraform
        env:
          TF_VAR_do_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}
          TF_VAR_jwt_expires_in: ${{ secrets.JWT_EXPIRES_IN }}
        run: terraform plan -var-file=env/dev.tfvars

      - name: Terraform apply (dev)
        working-directory: infra/terraform
        env:
          TF_VAR_do_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}
          TF_VAR_jwt_expires_in: ${{ secrets.JWT_EXPIRES_IN }}
        run: terraform apply -auto-approve -var-file=env/dev.tfvars

      - name: Export Terraform outputs (for downstream jobs)
        id: tf_outputs
        working-directory: infra/terraform
        run: |
          set -euo pipefail

          DB_URL="$(terraform output -raw database_url)"
          if [ -z "${DB_URL}" ]; then
            echo "ERROR: terraform output database_url is empty. This usually means the DB cluster wasn't created/imported correctly, or outputs were not updated in state."
            terraform output || true
            terraform state list || true
            exit 1
          fi

          echo "::add-mask::$DB_URL"
          {
            echo "database_url<<EOF"
            echo "$DB_URL"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

# =========================================================
# 1️⃣ DATABASE – Migrations & Deterministic Seeding
# =========================================================
  database:
    name: Database Setup
    runs-on: ubuntu-latest
    needs: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install database dependencies
        working-directory: database
        run: npm install

      # ---- Run migrations (TLS-safe for Aiven) ----
      - name: Run migrations
        working-directory: database
        env:
          DATABASE_URL: ${{ needs.terraform.outputs.database_url }}
        run: npm run migrate:latest

      # ---- Seed database IF EMPTY (single source of truth) ----
      - name: Seed database if empty
        working-directory: database
        env:
          DATABASE_URL: ${{ needs.terraform.outputs.database_url }}
        run: |
          cat > seed-if-empty.js << 'SCRIPT_EOF'
          require('ts-node/register');
          const config = require('./knexfile.ts').default;
          const knex = require('knex');
          const { execSync } = require('child_process');

          const db = knex(config.production || config.development);

          async function run() {
            const result = await db('devices').count('* as count').first();
            const count = Number(result.count || 0);

            if (count === 0) {
              console.log('Database empty → running seeds');
              execSync('npm run seed', { stdio: 'inherit' });
            } else {
              console.log('Database already seeded → skipping');
            }

            await db.destroy();
          }

          run().catch(async (e) => {
            console.error(e);
            await db.destroy();
            process.exit(1);
          });
          SCRIPT_EOF

          node seed-if-empty.js


# =========================================================
# 2️⃣ DEVICE SERVICE
# =========================================================
  device-service:
    name: Device Service
    runs-on: ubuntu-latest
    needs: database

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: backend/device-service
        run: npm install

      - name: Run unit tests
        working-directory: backend/device-service
        run: npm run test:unit

      - name: Run integration tests
        working-directory: backend/device-service
        env:
          DATABASE_URL: ${{ needs.terraform.outputs.database_url }}
        run: npm run test:integration

      - name: Build project
        working-directory: backend/device-service
        run: npm run build

      - name: Trigger DigitalOcean deployment
        run: |
          APP_ID=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.digitalocean.com/v2/apps | jq -r '.apps[] | select(.spec.name == env.DEVICE_APP_NAME) | .id' | head -n 1)

          if [ -z "$APP_ID" ] || [ "$APP_ID" = "null" ]; then
            echo "Could not find app id for ${DEVICE_APP_NAME}"
            exit 1
          fi

          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.digitalocean.com/v2/apps/$APP_ID/deployments


# =========================================================
# 3️⃣ LOAN SERVICE
# =========================================================
  loan-service:
    name: Loan Service
    runs-on: ubuntu-latest
    needs: device-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: backend/loan-service
        run: npm install

      - name: Run unit tests
        working-directory: backend/loan-service
        run: npm run test:unit

      - name: Run integration tests
        working-directory: backend/loan-service
        env:
          DATABASE_URL: ${{ needs.terraform.outputs.database_url }}
        run: npm run test:integration

      - name: Build project
        working-directory: backend/loan-service
        run: npm run build

      - name: Trigger DigitalOcean deployment
        run: |
          APP_ID=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.digitalocean.com/v2/apps | jq -r '.apps[] | select(.spec.name == env.LOAN_APP_NAME) | .id' | head -n 1)

          if [ -z "$APP_ID" ] || [ "$APP_ID" = "null" ]; then
            echo "Could not find app id for ${LOAN_APP_NAME}"
            exit 1
          fi

          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.digitalocean.com/v2/apps/$APP_ID/deployments


# =========================================================
# 4️⃣ FRONTEND
# =========================================================
  frontend:
    name: Frontend
    runs-on: ubuntu-latest
    needs: loan-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: frontend
        run: npm install

      - name: Run tests
        working-directory: frontend
        run: npm test

      - name: Build Next.js app
        working-directory: frontend
        run: npm run build

      - name: Trigger DigitalOcean deployment
        run: |
          APP_ID=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.digitalocean.com/v2/apps | jq -r '.apps[] | select(.spec.name == env.FRONTEND_APP_NAME) | .id' | head -n 1)

          if [ -z "$APP_ID" ] || [ "$APP_ID" = "null" ]; then
            echo "Could not find app id for ${FRONTEND_APP_NAME}"
            exit 1
          fi

          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.digitalocean.com/v2/apps/$APP_ID/deployments

