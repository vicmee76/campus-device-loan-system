name: Full Deployment Pipeline

"on":
  workflow_dispatch:
  push:
    branches:
      - main

env:
  DEVICE_APP_NAME: device-service-dev
  LOAN_APP_NAME: loan-service-dev
  FRONTEND_APP_NAME: campus-frontend-dev

jobs:
# =========================================================
# Infrastructure managed by DigitalOcean App Platform
# Auto-deploys on push to main
# =========================================================

# =========================================================
# 0️⃣ TERRAFORM – Provision DigitalOcean App Platform Apps
# =========================================================
  terraform:
    name: Terraform (Provision Apps)
    runs-on: ubuntu-latest
    outputs:
      database_url: ${{ steps.tf_outputs.outputs.database_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform init
        working-directory: infra/terraform
        env:
          TF_VAR_do_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
        run: terraform init

      - name: Terraform validate
        working-directory: infra/terraform
        run: terraform validate

      - name: Terraform plan
        working-directory: infra/terraform
        env:
          TF_VAR_do_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}
          TF_VAR_jwt_expires_in: ${{ secrets.JWT_EXPIRES_IN }}
        run: terraform plan -var-file=env/dev.tfvars

      - name: Terraform apply (dev)
        working-directory: infra/terraform
        env:
          TF_VAR_do_token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}
          TF_VAR_jwt_expires_in: ${{ secrets.JWT_EXPIRES_IN }}
        run: terraform apply -auto-approve -var-file=env/dev.tfvars

      - name: Export Terraform outputs (for downstream jobs)
        id: tf_outputs
        working-directory: infra/terraform
        run: |
          DB_URL="$(terraform output -raw database_url)"
          echo "::add-mask::$DB_URL"
          echo "database_url=$DB_URL" >> "$GITHUB_OUTPUT"

# =========================================================
# 1️⃣ DATABASE – Migrations & Deterministic Seeding
# =========================================================
  database:
    name: Database Setup
    runs-on: ubuntu-latest
    needs: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install database dependencies
        working-directory: database
        run: npm install

      # ---- Run migrations (TLS-safe for Aiven) ----
      - name: Run migrations
        working-directory: database
        env:
          DATABASE_URL: ${{ needs.terraform.outputs.database_url }}
        run: npm run migrate:latest

      # ---- Seed database IF EMPTY (single source of truth) ----
      - name: Seed database if empty
        working-directory: database
        env:
          DATABASE_URL: ${{ needs.terraform.outputs.database_url }}
        run: |
          cat > seed-if-empty.js << 'SCRIPT_EOF'
          require('ts-node/register');
          const config = require('./knexfile.ts').default;
          const knex = require('knex');
          const { execSync } = require('child_process');

          const db = knex(config.production || config.development);

          async function run() {
            const result = await db('devices').count('* as count').first();
            const count = Number(result.count || 0);

            if (count === 0) {
              console.log('Database empty → running seeds');
              execSync('npm run seed', { stdio: 'inherit' });
            } else {
              console.log('Database already seeded → skipping');
            }

            await db.destroy();
          }

          run().catch(async (e) => {
            console.error(e);
            await db.destroy();
            process.exit(1);
          });
          SCRIPT_EOF

          node seed-if-empty.js


# =========================================================
# 2️⃣ DEVICE SERVICE
# =========================================================
  device-service:
    name: Device Service
    runs-on: ubuntu-latest
    needs: database

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: backend/device-service
        run: npm install

      - name: Run unit tests
        working-directory: backend/device-service
        run: npm run test:unit

      - name: Run integration tests
        working-directory: backend/device-service
        env:
          DATABASE_URL: ${{ needs.terraform.outputs.database_url }}
        run: npm run test:integration

      - name: Build project
        working-directory: backend/device-service
        run: npm run build

      - name: Trigger DigitalOcean deployment
        run: |
          APP_ID=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.digitalocean.com/v2/apps | jq -r '.apps[] | select(.spec.name == env.DEVICE_APP_NAME) | .id' | head -n 1)

          if [ -z "$APP_ID" ] || [ "$APP_ID" = "null" ]; then
            echo "Could not find app id for ${DEVICE_APP_NAME}"
            exit 1
          fi

          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.digitalocean.com/v2/apps/$APP_ID/deployments


# =========================================================
# 3️⃣ LOAN SERVICE
# =========================================================
  loan-service:
    name: Loan Service
    runs-on: ubuntu-latest
    needs: device-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: backend/loan-service
        run: npm install

      - name: Run unit tests
        working-directory: backend/loan-service
        run: npm run test:unit

      - name: Run integration tests
        working-directory: backend/loan-service
        env:
          DATABASE_URL: ${{ needs.terraform.outputs.database_url }}
        run: npm run test:integration

      - name: Build project
        working-directory: backend/loan-service
        run: npm run build

      - name: Trigger DigitalOcean deployment
        run: |
          APP_ID=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.digitalocean.com/v2/apps | jq -r '.apps[] | select(.spec.name == env.LOAN_APP_NAME) | .id' | head -n 1)

          if [ -z "$APP_ID" ] || [ "$APP_ID" = "null" ]; then
            echo "Could not find app id for ${LOAN_APP_NAME}"
            exit 1
          fi

          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.digitalocean.com/v2/apps/$APP_ID/deployments


# =========================================================
# 4️⃣ FRONTEND
# =========================================================
  frontend:
    name: Frontend
    runs-on: ubuntu-latest
    needs: loan-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: frontend
        run: npm install

      - name: Run tests
        working-directory: frontend
        run: npm test

      - name: Build Next.js app
        working-directory: frontend
        run: npm run build

      - name: Trigger DigitalOcean deployment
        run: |
          APP_ID=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.digitalocean.com/v2/apps | jq -r '.apps[] | select(.spec.name == env.FRONTEND_APP_NAME) | .id' | head -n 1)

          if [ -z "$APP_ID" ] || [ "$APP_ID" = "null" ]; then
            echo "Could not find app id for ${FRONTEND_APP_NAME}"
            exit 1
          fi

          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.digitalocean.com/v2/apps/$APP_ID/deployments

