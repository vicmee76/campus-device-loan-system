name: Full Deployment Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
# =========================================================
# Infrastructure managed by DigitalOcean App Platform
# Auto-deploys on push to main
# =========================================================

# =========================================================
# 1️⃣ DATABASE – Migrations & Deterministic Seeding
# =========================================================
  database:
    name: Database Setup
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install database dependencies
        working-directory: database
        run: npm install

      # ---- Run migrations (TLS-safe for Aiven) ----
      - name: Run migrations
        working-directory: database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npm run migrate:latest

      # ---- Seed database IF EMPTY (single source of truth) ----
      - name: Seed database if empty
        working-directory: database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cat > seed-if-empty.js << 'SCRIPT_EOF'
          require('ts-node/register');
          const config = require('./knexfile.ts').default;
          const knex = require('knex');
          const { execSync } = require('child_process');

          const db = knex(config.production || config.development);

          async function run() {
            const result = await db('devices').count('* as count').first();
            const count = Number(result.count || 0);

            if (count === 0) {
              console.log('Database empty → running seeds');
              execSync('npm run seed', { stdio: 'inherit' });
            } else {
              console.log('Database already seeded → skipping');
            }

            await db.destroy();
          }

          run().catch(async (e) => {
            console.error(e);
            await db.destroy();
            process.exit(1);
          });
          SCRIPT_EOF

          node seed-if-empty.js


# =========================================================
# 2️⃣ DEVICE SERVICE
# =========================================================
  device-service:
    name: Device Service
    runs-on: ubuntu-latest
    needs: database

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: backend/device-service
        run: npm install

      - name: Run unit tests
        working-directory: backend/device-service
        run: npm run test:unit

      - name: Run integration tests
        working-directory: backend/device-service
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npm run test:integration

      - name: Build project
        working-directory: backend/device-service
        run: npm run build

      - name: Trigger DigitalOcean deployment
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.digitalocean.com/v2/apps/${{ secrets.DEVICE_APP_ID }}/deployments


# =========================================================
# 3️⃣ LOAN SERVICE
# =========================================================
  loan-service:
    name: Loan Service
    runs-on: ubuntu-latest
    needs: device-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: backend/loan-service
        run: npm install

      - name: Run unit tests
        working-directory: backend/loan-service
        run: npm run test:unit

      - name: Run integration tests
        working-directory: backend/loan-service
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npm run test:integration

      - name: Build project
        working-directory: backend/loan-service
        run: npm run build

      - name: Trigger DigitalOcean deployment
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.digitalocean.com/v2/apps/${{ secrets.LOAN_APP_ID }}/deployments


# =========================================================
# 4️⃣ FRONTEND
# =========================================================
  frontend:
    name: Frontend
    runs-on: ubuntu-latest
    needs: loan-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: frontend
        run: npm install

      - name: Run tests
        working-directory: frontend
        run: npm test

      - name: Build Next.js app
        working-directory: frontend
        run: npm run build

      - name: Deploy frontend
        run: echo "Frontend deployment step — configure hosting target"

