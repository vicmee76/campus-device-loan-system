# Loan Service

Loan Service for Campus Device Loan System - Handles loan operations and lifecycle management.

## Overview

This service manages the loan lifecycle including:
- Loan creation and management
- Loan status tracking
- Return processing
- Overdue handling
- Loan history

## Authentication

**Important**: This service validates JWT tokens issued by the Device Service using a shared secret.

### Token Validation

- The Loan Service **does not** generate tokens
- Tokens are generated by the Device Service during user login
- Both services must share the same `JWT_SECRET` environment variable
- The Loan Service verifies tokens locally using the shared secret
- This approach is stateless, efficient, and requires no network calls

### Environment Variables

Both services must have matching JWT configuration:

```env
# Shared between Device Service and Loan Service
JWT_SECRET=your-shared-secret-key
JWT_EXPIRES_IN=24h
```

**⚠️ Important**: The `JWT_SECRET` must be identical in both services for token validation to work.

### Usage

When making requests to the Loan Service, include the token from Device Service:

```bash
# 1. Login to Device Service to get token
curl -X POST http://localhost:7778/v1/api/users/login \
  -H "Content-Type: application/json" \
  -d '{"email": "user@example.com", "password": "password"}'

# 2. Use the token to call Loan Service
curl -H "Authorization: Bearer <token-from-device-service>" \
  http://localhost:7779/v1/api/loans/get-all-loans
```

### Token Validation Flow

1. Client sends request to Loan Service with `Authorization: Bearer <token>` header
2. Loan Service extracts token from header
3. Loan Service verifies token locally using shared `JWT_SECRET`
4. If valid, user information (userId, email, role) is extracted from token
5. Request proceeds with authenticated user context

## Setup

1. Install dependencies:
```bash
npm install
```

2. Set up environment variables:
   ```bash
   cp .env.example .env
   # Edit .env with your configuration
   ```

   **Required Environment Variables:**
   - `DATABASE_URL` - PostgreSQL connection string (e.g., `postgresql://user:password@host:port/database`)
   - `JWT_SECRET` - Shared secret for JWT validation (MUST match Device Service)
   - `JWT_EXPIRES_IN` - Token expiration time (e.g., `24h`)
   - `PORT` - Service port (default: 7779)
   - `NODE_ENV` - Environment (development, production, test)
   - `CORS_ORIGIN` - Allowed CORS origin (default: `*`)
   - `LOG_LEVEL` - Logging level: DEBUG, INFO, WARN, ERROR (default: DEBUG)

   **Optional:**
   - `SIMULATE_EMAIL_FAILURE` - Set to `true` to simulate email failures for testing

3. **Important**: This service does NOT run migrations.
   - Migrations are located in the global `/database` folder at the project root
   - Migrations must be executed manually or via CI/CD BEFORE deploying
   - Run migrations from the project root:
   ```bash
   npx knex --knexfile database/knexfile.ts migrate:latest
   ```

4. Start the service:
```bash
npm run dev
```

## Database Connection

This service connects to the shared PostgreSQL database using `DATABASE_URL` environment variable.

**Note**: Each service has its own `knexfile.ts` for database connections only. Migrations are managed globally in `/database`.

## Scripts

- `npm run build` - Build TypeScript to JavaScript
- `npm start` - Start production server
- `npm run dev` - Start development server with hot reload
- `npm test` - Run all tests
- `npm run test:unit` - Run unit tests only
- `npm run test:integration` - Run integration tests only
- `npm run test:coverage` - Run tests with coverage report

## Port

Default port: **7779** (Device Service uses 7778)

## API Endpoints

See [API Reference](../API_REFERENCE.md) for complete endpoint documentation.

### Health & Monitoring

- `GET /health` - Liveness probe (service is running)
- `GET /ready` - Readiness probe (database is reachable)
- `GET /metrics` - Prometheus-style metrics

### Loan Management

- `PATCH /v1/api/loans/:reservationId/collect` - Mark reservation as collected and create loan (staff only)
- `PATCH /v1/api/loans/:loanId/return` - Mark loan as returned and update inventory (staff only)
- `GET /v1/api/loans/get-all-loans` - Get all loans with pagination (staff only)
- `GET /v1/api/loans/user/:userId` - Get loans for a specific user (staff only)

## Architecture

- **Controllers**: Handle HTTP requests/responses
- **Services**: Business logic layer
- **Repositories**: Database access layer
- **DTOs**: Data Transfer Objects
- **Factories**: Transform between DTOs and database models
- **Validations**: Request validation rules

## Testing

See `src/test/README.md` for testing documentation.

### Running Tests

```bash
# Run all tests
npm test

# Run unit tests only
npm run test:unit

# Run integration tests only
npm run test:integration

# Run with coverage
npm run test:coverage
```

## Related Documentation

- [API Reference](../API_REFERENCE.md) - Complete API documentation
- [Main Project README](../../README.md) - Project overview
- [Database Guide](../database/database.md) - Database migrations and seeds

